#!/usr/bin/env bash
set -e

# Check requirements
function require {
    command -v $1 > /dev/null 2>&1 || {
        echo "Some of the required software is not installed:"
        echo "    please install $1" >&2;
        exit 1;
    }
}

# Check for AWS, AWS Command Line Interface
require aws
# Check for jq, Command-line JSON processor
require jq

while [[ $# > 0 ]]
do
    key="$1"

    case $key in
        --region)
            REGION="$2"
            shift # past argument
            ;;
        --repository)
            REPOSITORY="$2"
            shift
            ;;
        *)
        ;;
    esac
    shift # past argument or value
done

echo "region is $REGION"
echo "repository is $REPOSITORY"

AWS_ECR_COMMAND="aws --output json ecr --region $REGION" #intended space at the end.
AWS_RESPONSE_JSON=`$AWS_ECR_COMMAND describe-images --repository-name $REPOSITORY  --query 'sort_by(imageDetails,& imagePushedAt)[*]'`
AWS_ECR_COUNT=`echo $AWS_RESPONSE_JSON | jq '.[0:length-5] | length'`
echo "There are $AWS_ECR_COUNT images in the $REPOSITORY repository"

if [[ $AWS_ECR_COUNT == 0 ]]; then
	echo "Less than 5 images in ECR so nothing will be deleted."
	exit 0;
fi

AWS_REQUEST_JSON=`echo $AWS_RESPONSE_JSON | jq '{repositoryName: "$REPOSITORY", imageIds: [.[0:length-5] | .[] | {imageDigest: .imageDigest}]}'`
AWS_RESPONSE_JSON=`$AWS_ECR_COMMAND batch-delete-image --repository-name $REPOSITORY --cli-input-json ''"$AWS_REQUEST_JSON"''`
exit $lastexitcode